name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: self-hosted
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: true
      - name: Test the library
        run: |
          cargo +nightly fmt -- --check
          timeout 1h cargo test
          cargo bench --no-run
  benchskylake2x:
    needs: build
    runs-on: [self-hosted, skylake2x]
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: true
      - name: Benchmarking on skylak2x
        run: bash scripts/ci.bash
    env:
      CI_MACHINE_TYPE: "skylake2x"
